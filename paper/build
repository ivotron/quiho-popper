mkdir -p out

docker run \
  --rm \
  --workdir="/root" \
  -v `pwd`/.deps/default.latex:/root/.pandoc/templates/default.latex:z \
  -v `pwd`/.deps/ieee.csl:/root/ieee.csl:z \
  -v `pwd`/.deps/latex-styles:/root/texmf/tex/latex:z \
  -v `pwd`/.deps/pandoc-tabularize.py:/root/pandoc-tabularize.py:z \
  -v `pwd`/refs.bib:/root/refs.bib:z \
  -v `pwd`/paper.md:/root/paper.md:z \
  -v `pwd`/figures:/root/figures:z \
  -v `pwd`/../pipelines:/root/pipelines:z \
  -v `pwd`/out:/root/out:z \
  ivotron/pandoc:1.19.2.1 \
    --metadata acmart=true \
    --metadata documentclass=acmart \
    --metadata classoption=sigconf \
    --metadata natbib=false \
    --metadata usedefaultspacing=true \
    --metadata numbersections=true \
    --metadata secPrefix=section \
    --standalone \
    --smart \
    --highlight-style tango \
    --bibliography refs.bib \
    --csl ieee.csl \
    --filter pandoc-tabularize.py \
    --filter pandoc-crossref \
    --filter pandoc-citeproc \
    --output=out/paper.pdf \
    paper.md 2> build.log

if [ $? -ne 0 ] ; then
  echo "ERROR"
  cat build.log
  rm build.log
  exit 1
fi

mv out/paper.pdf .
rm -r out
rm build.log

exit 0


## commands for stitching figures (relative to pipelines/single-node/results/figures)
#
# montage \
#   -border 0 \
#   -mode concatenate \
#   -tile 2x2 \
#   redis-get.png redis-set.png ssca.png sklearn.png \
#   four.png
#
# montage \
#   -border 0 \
#   -mode concatenate \
#   -tile 2x2 \
#   innodb_load.png memory_load.png \
#   mariadb-innodb-vs-memory.png
#
# montage \
#   -border 0 \
#   -mode concatenate \
#   -tile 2x6 \
#   add-1.png add-2.png add-4.png add-6.png add-8.png add-10.png add-12.png add-14.png add-16.png add-18.png \
#   stream-nadds.png
#
# montage \
#   -border 0 \
#   -mode concatenate \
#   -tile 2x6 \
#   mariadb-10.3.2-innodb_load.png mariadb-5.5.58-innodb_load.png \
#   mariadb-innodb-regression.png
